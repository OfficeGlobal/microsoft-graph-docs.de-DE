# <a name="call-microsoft-graph-from-a-cloud-solution-provider-application"></a><span data-ttu-id="918c3-101">Aufrufen von Microsoft Graph aus einer Anwendung eines Cloud-Lösungsanbieters</span><span class="sxs-lookup"><span data-stu-id="918c3-101">Call Microsoft Graph from a Cloud Solution Provider application</span></span>

> <span data-ttu-id="918c3-p101">**Hinweis:** Dieses Thema gilt **nur** für Microsoft CSP-Anwendungsentwickler (Cloud-Lösungsanbieter). Das Programm [Microsoft Cloud-Lösungsanbieter (CSP)](https://partner.microsoft.com/de-DE/cloud-solution-provider) ermöglicht es Microsoft-Partnern, Microsoft Onlinedienste an Kunden zu verkaufen und zu verwalten.</span><span class="sxs-lookup"><span data-stu-id="918c3-p101">**Note:** This topic applies **only** to Microsoft Cloud Solution Provider (CSP) application developers. The [Microsoft Cloud Solution Provider (CSP)](https://partner.microsoft.com/de-DE/cloud-solution-provider) program enables Microsoft’s partners to resell and manage Microsoft Online services to customers.</span></span>

<span data-ttu-id="918c3-104">In diesem Thema wird beschrieben, wie Sie Anwendungszugriff auf partnerverwaltete Kundendaten über Microsoft Graph aktivieren, entweder mit dem [Fluss zur Erteilung von Autorisierungscodes](https://docs.microsoft.com/de-DE/azure/active-directory/develop/active-directory-protocols-oauth-code) oder dem [Fluss zur Gewährung von Clientanmeldeinformationen für Dienst-zu-Dienst-Aufrufe](https://docs.microsoft.com/de-DE/azure/active-directory/develop/active-directory-protocols-oauth-service-to-service).</span><span class="sxs-lookup"><span data-stu-id="918c3-104">This topic describes how to enable application access to partner-managed customer data via Microsoft Graph using either the [authorization code grant flow](https://docs.microsoft.com/de-DE/azure/active-directory/develop/active-directory-protocols-oauth-code) or the [service to service client credentials flow](https://docs.microsoft.com/de-DE/azure/active-directory/develop/active-directory-protocols-oauth-service-to-service).</span></span>

<span data-ttu-id="918c3-105">**Wichtig:** Das Aufrufen von Microsoft Graph aus einer CSP-Anwendung wird nur für Verzeichnisressourcen (z. B. **user**, **group**,**device**, **organization**) und [Intune](..\api-reference\beta\resources\intune_graph_overview.md)-Ressourcen unterstützt.</span><span class="sxs-lookup"><span data-stu-id="918c3-105">**Important:** Calling Microsoft Graph from a CSP application is only supported for directory resources (such as **user**, **group**,**device**, **organization**) and [Intune](..\api-reference\beta\resources\intune_graph_overview.md) resources.</span></span>

## <a name="what-is-a-partner-managed-application"></a><span data-ttu-id="918c3-106">Was ist eine partnerverwaltete Anwendung?</span><span class="sxs-lookup"><span data-stu-id="918c3-106">What is a partner-managed application</span></span>

<span data-ttu-id="918c3-p102">Das CSP-Programm ermöglicht es Microsoft-Partnern, Microsoft-Onlinedienste (z. B. Office 365, Microsoft Azure und CRM Online) an Kunden zu verkaufen und zu verwalten. Die Verwaltung von Kundendiensten erfolgt über delegierte Administratorberechtigungen, wodurch festgelegte Partnerbenutzer (als Agenten bezeichnet) auf die Umgebungen ihrer Kunden zugreifen und diese konfigurieren können.</span><span class="sxs-lookup"><span data-stu-id="918c3-p102">The CSP program enables Microsoft’s partners to resell and manage Microsoft Online Services (such as Office 365, Microsoft Azure, and CRM Online) to customers. Management of customer services is done through Delegated Admin Privileges, which enables designated partner users (known as agents) to access and configure their customers’ environments.</span></span>

<span data-ttu-id="918c3-p103">Darüber hinaus können Sie als Partnerentwickler eine **partnerverwaltete App** zum Verwalten der Microsoft-Dienste Ihrer Kunden erstellen. Partnerverwaltete Apps werden oft als *vorab genehmigte* Apps bezeichnet, da alle Ihre Kunden automatisch vorab für Ihre partnerverwalteten Apps genehmigt werden. Dies bedeutet Folgendes: Wenn ein Benutzer aus einem Ihrer Kundenmandanten eine Ihrer partnerverwalteten Apps verwendet, kann der Benutzer die App nutzen, ohne dass er zur Zustimmung aufgefordert wird. Partnerverwaltete Apps erben außerdem delegierte Administratorberechtigungen, sodass Ihre Partneragenten über Ihre partnerverwaltete Anwendung ebenfalls privilegierten Zugriff auf Ihre Kunden erhalten.</span><span class="sxs-lookup"><span data-stu-id="918c3-p103">Additionally, as a partner developer, you can build a **partner-managed app** to manage your customers' Microsoft services. Partner-managed apps are often called *pre-consented* apps because all your customers are automatically pre-consented for your partner-managed apps. This means when a user from one of your customer tenants uses one of your partner-managed apps, the user can use it without being prompted to give consent. Partner-managed apps also inherit Delegated Admin Privileges, so your partner agents can also get privileged access to your customers through your partner-managed application.</span></span>

## <a name="how-to-set-up-a-partner-managed-application"></a><span data-ttu-id="918c3-113">Einrichten einer partnerverwalteten Anwendung</span><span class="sxs-lookup"><span data-stu-id="918c3-113">How to set-up a partner-managed application</span></span>

<span data-ttu-id="918c3-114">Eine Anwendung wird als *partnerverwaltet* betrachtet, wenn ihr erhöhte Rechte zum Zugreifen auf die Daten Ihrer Kunden gewährt werden.</span><span class="sxs-lookup"><span data-stu-id="918c3-114">An application is viewed as *partner-managed* when it is granted elevated permissions to access your customers' data.</span></span>

> <span data-ttu-id="918c3-115">**Hinweis:** Partnerverwaltete Apps können *nur* auf Partnermandanten konfiguriert werden, und zum Verwalten von Ressourcen des Kundenmandanten **müssen** partnerverwaltete Apps als **mehrinstanzenfähige Anwendungen** konfiguriert werden.</span><span class="sxs-lookup"><span data-stu-id="918c3-115">**Note:** Partner-managed apps can *only* be configured on Partner tenants, and in order to manage customer tenant resources, partner-managed apps **must** be configured as **multi-tenant applications**.</span></span>

### <a name="register-and-configure-a-multi-tenant-app"></a><span data-ttu-id="918c3-116">Registrieren und Konfigurieren einer mehrinstanzenfähigen App</span><span class="sxs-lookup"><span data-stu-id="918c3-116">Register and configure a multi-tenant app</span></span>

<span data-ttu-id="918c3-117">Die ersten hier erforderlichen Schritte entsprechen weitgehend den Schritten zum Registrieren und Konfigurieren einer mehrinstanzenfähigen Anwendung:</span><span class="sxs-lookup"><span data-stu-id="918c3-117">The initial steps required here follow most of the same steps used to register and configure a multi-tenant application:</span></span>

1. <span data-ttu-id="918c3-p104">[Registrieren Sie die Anwendung](https://docs.microsoft.com/de-DE/azure/active-directory/active-directory-app-registration) in Ihrem Partnermandanten über das [Azure-Portal](https://portal.azure.com). Um als partnerverwaltete App ausgeführt werden zu können, muss eine Anwendung als [mehrinstanzenfähige App](https://docs.microsoft.com/de-DE/azure/active-directory/develop/active-directory-devhowto-multi-tenant-overview#update-registration-to-be-multi-tenant) konfiguriert werden. Falls Ihre App in mehreren geografische Regionen bereitgestellt und verkauft wird, müssen Sie Ihre App außerdem in jeder dieser Regionen registrieren, wie <a href="#region">hier</a> beschrieben.</span><span class="sxs-lookup"><span data-stu-id="918c3-p104">[Register your application](https://docs.microsoft.com/de-DE/azure/active-directory/active-directory-app-registration) in your Partner tenant using the [Azure Portal](https://portal.azure.com). To function as a partner-managed app, an application must be configured as a [multi-tenant app](https://docs.microsoft.com/de-DE/azure/active-directory/develop/active-directory-devhowto-multi-tenant-overview#update-registration-to-be-multi-tenant). Additionally, if your app is deployed and sold in multiple geographic regions you will need to register your app in each of those regions as described <a href="#region">here</a>.</span></span>
2. <span data-ttu-id="918c3-121">Konfigurieren Sie Ihre mehrinstanzenfähige App über das Azure-Portal mit den *erforderlichen Berechtigungen*; verwenden Sie einen Ansatz geringster Rechte.</span><span class="sxs-lookup"><span data-stu-id="918c3-121">Configure your multi-tenant app, again through the Azure Portal, with the *required permissions* it needs using a least privileged approach.</span></span>

### <a name="pre-consent-your-app-for-all-your-customers"></a><span data-ttu-id="918c3-122">Vorabgenehmigen Ihrer App für alle Ihre Kunden</span><span class="sxs-lookup"><span data-stu-id="918c3-122">Pre-consent your app for all your customers</span></span>

<span data-ttu-id="918c3-p105">Zum Schluss gewähren Sie Ihrer partnerverwalteten App diese konfigurierten Berechtigungen für alle Ihre Kunden. Hierzu können Sie den **servicePrincipal**, der die App darstellt, mithilfe von Azure AD PowerShell V2 zur Gruppe *Adminagents* in Ihrem Partnermandanten hinzufügen. Sie können Azure AD PowerShell V2 [hier](https://www.powershellgallery.com/packages/AzureAD) herunterladen und installieren.  Führen Sie die folgenden Schritte aus, um die Gruppe *Adminagents* und den **servicePrincipal** zu suchen und ihn zur Gruppe hinzuzufügen.</span><span class="sxs-lookup"><span data-stu-id="918c3-p105">Finally grant your partner-managed app those configured permissions for all your customers. You can do this by adding the **servicePrincipal** that represents the app to the *Adminagents* group in your Partner tenant, using Azure AD powershell V2. You can download and install Azure AD PowerShell V2 from [here](https://www.powershellgallery.com/packages/AzureAD).  Follow these steps to find the *Adminagents* group, the **servicePrincipal** and add it to the group.</span></span>

1. <span data-ttu-id="918c3-127">Öffnen Sie eine PowerShell-Sitzung und stellen Sie eine Verbindung mit Ihrem Partnermandanten her, indem Sie Ihre Administrator-Anmeldeinformationen in das Anmeldefenster eingeben.</span><span class="sxs-lookup"><span data-stu-id="918c3-127">Open a PowerShell session and connect to your partner tenant by entering your admin credentials into the sign-in window.</span></span>

    ```PowerShell
    Connect-AzureAd
    ```

2. <span data-ttu-id="918c3-128">Suchen Sie die Gruppe, die die *Adminagents* darstellt.</span><span class="sxs-lookup"><span data-stu-id="918c3-128">Find the group that represents the *Adminagents*.</span></span>

    ```PowerShell
    $group = Get-AzureADGroup -Filter "displayName eq 'Adminagents'"
    ```

3. <span data-ttu-id="918c3-129">Suchen Sie den Dienstprinzipal, der die gleiche *appId* hat wie Ihre App.</span><span class="sxs-lookup"><span data-stu-id="918c3-129">Find the service principal that has the same *appId* as your app.</span></span>

    ```PowerShell
    $sp = Get-AzureADServicePrincipal -Filter "appId eq '{yourAppsAppId}'"
    ```

4. <span data-ttu-id="918c3-130">Fügen Sie zum Schluss den Dienstprinzipal zur Gruppe *Adminagents* hinzu.</span><span class="sxs-lookup"><span data-stu-id="918c3-130">Finally, add the service principal to the *Adminagents* group.</span></span>

    ```PowerShell
    Add-AzureADGroupMember -ObjectId $group.ObjectId -RefObjectId $sp.ObjectId
    ```

## <a name="token-acquisition-flows"></a><span data-ttu-id="918c3-131">Tokenerwerbsflüsse</span><span class="sxs-lookup"><span data-stu-id="918c3-131">Token acquisition flows</span></span>

<span data-ttu-id="918c3-132">Die Tokenerwerbsflüsse für partnerverwaltete Apps – [Fluss zur Erteilung von Autorisierungscodes](https://docs.microsoft.com/de-DE/azure/active-directory/develop/active-directory-protocols-oauth-code) und [Fluss zur Gewährung von Clientanmeldeinformationen für Dienst-zu-Dienst-Aufrufe](https://docs.microsoft.com/de-DE/azure/active-directory/develop/active-directory-protocols-oauth-service-to-service) – sind dieselben wie für normale mehrinstanzenfähige Apps.</span><span class="sxs-lookup"><span data-stu-id="918c3-132">Token acquisition flows for partner-managed apps - [authorization code grant flow](https://docs.microsoft.com/de-DE/azure/active-directory/develop/active-directory-protocols-oauth-code) and [service-to-service client credentials flow](https://docs.microsoft.com/de-DE/azure/active-directory/develop/active-directory-protocols-oauth-service-to-service) - are the same as regular multi-tenant apps.</span></span>

<span data-ttu-id="918c3-p106">Abgesehen vom vorab genehmigten Zugriff auf alle Ihre Kundenmandanten haben partnerverwaltete Apps eine zusätzliche Fähigkeit. Sie ermöglicht es Ihren Agenten, mit Ihrer App auf Mandantendaten Ihres Kunden zuzugreifen (mit delegierten Administratorrechten). Im Prinzip funktioniert es wie folgt:</span><span class="sxs-lookup"><span data-stu-id="918c3-p106">Apart from pre-consented access to all your customer tenants, partner-managed apps have one additional capability. It allows for your agents to use your app to access your customers' tenant data (using delegated admin privileges). Conceptually it works like this:</span></span>

1. <span data-ttu-id="918c3-136">Der Agent meldet sich mit seinen Benutzeranmeldeinformationen, die von Ihrem Partnermandanten ausgestellt wurden, bei Ihrer App an.</span><span class="sxs-lookup"><span data-stu-id="918c3-136">Your agent signs in to your app with their user credentials issued from your partner tenant.</span></span>
2. <span data-ttu-id="918c3-137">Die App fordert ein Zugriffstoken für den gewünschten partnerverwalteten Kundenmandanten an.</span><span class="sxs-lookup"><span data-stu-id="918c3-137">Your app requests an access token for the intended partner-managed customer tenant.</span></span>
3. <span data-ttu-id="918c3-138">Die App ruft unter Verwendung des Zugriffstokens Microsoft Graph auf.</span><span class="sxs-lookup"><span data-stu-id="918c3-138">Your app uses the access token to call Microsoft Graph.</span></span>

<span data-ttu-id="918c3-p107">Dies ist ein standardmäßiger [Fluss zur Erteilung von Autorisierungscodes](https://docs.microsoft.com/de-DE/azure/active-directory/develop/active-directory-protocols-oauth-code), mit der Ausnahme, dass Ihre Agenten sich mit ihren Partnerkonten anmelden müssen. Um anzuzeigen, wie dies aussieht, stellen Sie sich vor, Ihr Partnermandant ist *partner.com* (dies ist die Startmandant für Ihre Agenten) und einer Ihrer Kunden ist *customer.com*:</span><span class="sxs-lookup"><span data-stu-id="918c3-p107">This is a standard [authorization code grant flow](https://docs.microsoft.com/de-DE/azure/active-directory/develop/active-directory-protocols-oauth-code), except that your agents must sign-in using their partner accounts. To see how this would look, imagine your partner tenant is *partner.com* (which is the home tenant for your agents) and one of your customers is *customer.com*:</span></span>

1. <span data-ttu-id="918c3-p108">[Autorisierungscode erwerben:](https://docs.microsoft.com/de-DE/azure/active-directory/develop/active-directory-protocols-oauth-code#request-an-authorization-code) Die App sendet eine Anforderung an den Endpunkt ```/authorize``` und muss einen **Kundenmandanten**, in unserem Beispiel ```customer.com```, als Mandantenziel verwenden. Ihre Agenten melden sich weiterhin mit ihrem ```username@partner.com```-Konto an.</span><span class="sxs-lookup"><span data-stu-id="918c3-p108">[Acquire an authorization code:](https://docs.microsoft.com/de-DE/azure/active-directory/develop/active-directory-protocols-oauth-code#request-an-authorization-code) Your app makes a request to the ```/authorize``` endpoint and must use a **customer tenant**, in our example ```customer.com```, for the target tenant. Your agents would still sign-in with their ```username@partner.com``` account.</span></span>

    ```http
    GET https://login.microsoftonline.com/customer.com/oauth2/authorize
    ```

2. <span data-ttu-id="918c3-143">[Zugriffstoken mithilfe des Autorisierungscodes erwerben:](https://docs.microsoft.com/de-DE/azure/active-directory/develop/active-directory-protocols-oauth-code#use-the-authorization-code-to-request-an-access-token) Ihre App muss einen **Kundennandanten** als Zielmandanten verwenden, in unserem Beispiel ```customer.com```, wenn sie die Anforderung an den Endpunkt ```token``` sendet:</span><span class="sxs-lookup"><span data-stu-id="918c3-143">[Aquire an access token using the authorization code:](https://docs.microsoft.com/de-DE/azure/active-directory/develop/active-directory-protocols-oauth-code#use-the-authorization-code-to-request-an-access-token) Your app must use a **customer tenant** as the target tenant, in our example ```customer.com```, when making the request to the ```token``` endpoint:</span></span>

    ```http
    POST https://login.microsoftonline.com/customer.com/oauth2/token
    ```

3. <span data-ttu-id="918c3-144">Nachdem Sie jetzt über ein Zugriffstoken verfügen, rufen Sie Microsoft Graph auf, und fügen Sie das Zugriffstoken in den HTTP-Autorisierungsheader ein:</span><span class="sxs-lookup"><span data-stu-id="918c3-144">Now you have an access token, call Microsoft Graph, putting the access token in the HTTP authorization header:</span></span>

    ```http
    GET https://graph.microsoft.com/beta/users
    Authorization: Bearer <token>
    ```

## <a name="register-your-app-in-the-regions-you-support"></a><span data-ttu-id="918c3-145">Registrieren Ihrer App in den von Ihnen unterstützten Regionen</span><span class="sxs-lookup"><span data-stu-id="918c3-145">Register your app in the regions you support</span></span>
<a name="region"></a>

<span data-ttu-id="918c3-p109">Die Kundenbeteiligung am CSP-Programm ist derzeit auf eine einzige Region beschränkt. Für partnerverwaltete Anwendungen gilt dieselbe Einschränkung. Dies bedeutet, dass Sie einen separaten Mandanten für jede Regionen benötigen, in der Sie verkaufen. Wenn Ihre partnerverwaltete App beispielsweise in einem Mandanten in den USA registriert ist, Ihr Kunde aber in der EU sitzt, funktioniert die partnerverwaltete App nicht.  Jeder Ihrer regionalen Partnermandanten muss einen eigenen Satz partnerverwalteter Apps pflegen, um Kunden innerhalb der gleichen Region zu verwalten. Dies erfordert möglicherweise zusätzliche Logik in Ihrer App (vor der Anmeldung) zum Abrufen des Anmeldebenutzernamen Ihres Kunden, um zu entscheiden, welche regionsspezifische partnerverwaltete App-Identität für den Benutzer verwendet werden soll.</span><span class="sxs-lookup"><span data-stu-id="918c3-p109">CSP customer engagement is currently limited to a single region. Partner-managed applications carry the same limitation. This means you must have a separate tenant for each region you sell in. For example, if your partner-managed app is registered in a tenant in the US but your customer is in the EU – the partner-managed app will not work.  Each of your regional partner tenants must maintain their own set of partner-managed apps to manage customers within the same region. This might require additional logic in your app (prior to sign-in) to get your customers' sign-in username to decide which region-specific partner-managed app identity to use, to serve the user.</span></span>

## <a name="calling-microsoft-graph-immediately-after-customer-creation"></a><span data-ttu-id="918c3-152">Aufrufen von Microsoft Graph sofort nach dem Erstellen des Kunden</span><span class="sxs-lookup"><span data-stu-id="918c3-152">Calling Microsoft Graph immediately after customer creation</span></span>

<span data-ttu-id="918c3-p110">Wenn Sie einen neuen Kunden mit der [Partner Center-API](https://partnercenter.microsoft.com/de-DE/partner/developer) erstellen, wird ein neuer Kundenmandant erstellt. Darüber hinaus wird eine Partnerbeziehung erstellt, wodurch Sie zum gespeicherten Partner dieses neuen Kundenmandanten werden. Es kann bis zu drei Minuten dauern, bis diese Partnerbeziehung an den neuen Kundenmandanten verteilt wird. Wenn Ihre App Microsoft Graph direkt nach der Erstellung aufruft, erhält die App wahrscheinlich die Fehlermeldung, dass der Zugriff verweigert wurde. Eine ähnliche Verzögerung kann eintreten, wenn ein bestehender Kunde Ihre Einladung akzeptiert. Dies liegt daran, dass die Vorabzustimmung davon abhängt, dass die Partnerbeziehung im Kundenmandanten vorhanden ist.</span><span class="sxs-lookup"><span data-stu-id="918c3-p110">When you create a new customer using the [Partner Center API](https://partnercenter.microsoft.com/de-DE/partner/developer), a new customer tenant gets created. Additionally, a partner relationship also gets created, which makes you the partner of record for this new customer tenant. This partner relationship can take up to 3 minutes to propagate to the new customer tenant. If your app calls Microsoft Graph straight after creation, your app will likely receive an access denied error. A similar delay may be experienced when an existing customer accepts your invitation. This is because pre-consent relies on the partner relationship being present in the customer tenant.</span></span>

<span data-ttu-id="918c3-p111">Um dieses Problem zu vermeiden, wird empfohlen, dass die Partner-App nach der Kundenerstellung **drei Minuten** warten sollte, bevor sie Azure AD zum Erwerb eines Tokens (für den Aufruf von Microsoft Graph) aufruft. Hiermit sollten die meisten Fälle abgedeckt sein. Wenn jedoch nach Verstreichen der Wartezeit von drei Minuten weiterhin ein Autorisierungsfehler ausgegeben wird, warten Sie weitere 60 Sekunden, und versuchen Sie es erneut.</span><span class="sxs-lookup"><span data-stu-id="918c3-p111">To avoid this problem, we recommend that your partner app should should wait **three minutes** after customer creation before calling Azure AD to acquire a token (to call Microsoft Graph). This should cover most cases. However, if after waiting three minutes you still recieve an authorization error, please wait an additional 60 seconds and try again.</span></span>

> <span data-ttu-id="918c3-p112">**Hinweis:** Bei der Wiederholung müssen Sie ein neues Zugriffstoken von Azure AD erwerben, bevor Sie Microsoft Graph aufrufen.  Der Aufruf von Microsoft Graph mit dem bereits vorhandenen Zugriffstoken funktioniert nicht, da das Zugriffstoken nur eine Stunde lang gültig ist und die vorab genehmigten Berechtigungsansprüche nicht enthält.</span><span class="sxs-lookup"><span data-stu-id="918c3-p112">**Note:** On the retry, you must acquire a new access token from Azure AD, before calling Microsoft Graph.  Calling Microsoft Graph with the access token you already have will not work, because the access token is good for an hour and won’t contain the pre-consented permission claims.</span></span>
